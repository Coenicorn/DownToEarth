(()=>{"use strict";class t{x;y;constructor(t,e){this.x=t,this.y=e}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}mult(t){this.x*=t.x,this.y*=t.y}div(t){this.x/=t.x,this.y/=t.y}static get zeroVector(){return new t(0,0)}static get down(){return new t(0,1)}static get up(){return new t(0,-1)}static get left(){return new t(-1,0)}static get right(){return new t(1,0)}}class e{a;b;surfaceNormal;constructor(e,s){this.a=e,this.b=s;let i={x:this.b.x-this.a.x,y:this.b.y-this.a.y},n=Math.sqrt(Math.pow(i.x,2)+Math.pow(i.y,2));i.x/=n,i.y/=n,this.surfaceNormal=new t(i.y,-i.x)}intersectsLine(e){let s,i,n,o,h,r,c,a;s=this.a.x,i=this.a.y,n=this.b.x,o=this.b.y,h=e.a.x,r=e.a.y,c=e.b.x,a=e.b.y;let l=(s-n)*(r-a)-(i-o)*(h-c);if(0==l)return;let f=((s-h)*(r-a)-(i-r)*(h-c))/l,d=((s-h)*(i-o)-(i-r)*(s-n))/l;return f>=0&&f<=1&&d>=0&&d<=1?new t(s+f*(n-s),i+f*(o-i)):void 0}intersectsAABB(s){let i,n,o,h,r,c,a,l,f,d,x,u;return i=s.position.x,r=s.position.y,n=s.position.x+s.dimensions.x,c=s.position.y,o=s.position.x+s.dimensions.x,a=s.position.y+s.dimensions.y,h=s.position.x,l=s.position.y+s.dimensions.y,f=new e(new t(i,r),new t(n,c)),d=new e(new t(n,c),new t(o,a)),x=new e(new t(o,a),new t(h,l)),u=new e(new t(h,l),new t(i,r)),null!=this.intersectsLine(f)||null!=this.intersectsLine(d)||null!=this.intersectsLine(x)||null!=this.intersectsLine(u)}}class s{mesh;constructor(s){this.mesh=[];for(let i=1,n=s.length;i<n;i++)this.mesh.push(new e(new t(s[i-1].x,s[i-1].y),new t(s[i].x,s[i].y)));this.mesh.push(new e(new t(s[s.length-1].x,s[s.length-1].y),new t(s[0].x,s[0].y)))}static meshFromAABB(e){let i,n,o,h,r,c,a,l;return i=e.position.x,r=e.position.y,n=e.position.x+e.dimensions.x,c=e.position.y,o=e.position.x+e.dimensions.x,a=e.position.y+e.dimensions.y,h=e.position.x,l=e.position.y+e.dimensions.y,new s([new t(i,r),new t(n,c),new t(o,a),new t(h,l)])}getMesh(){return this.mesh}}function i(t){return new Promise(((e,s)=>{let i=new Image;i.src=t,i.onload=()=>e(i),i.onerror=()=>{throw new Error("Image not found")}}))}const n=new class{canvas;context;width;height;offset;center;camera;constructor(e,s){this.canvas=s?document.getElementById(s):document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.width=innerWidth,this.height=innerHeight,this.canvas.width=this.width,this.canvas.height=this.height,addEventListener("resize",this.resize.bind(this)),this.offset=t.zeroVector,this.center=new t(this.width/2,this.height/2),this.camera=e}resize(){this.width=innerWidth,this.height=innerHeight,this.canvas.width=this.width,this.canvas.height=this.height}clear(){this.context.clearRect(0,0,this.width,this.height)}color(t){this.context.fillStyle=t}drawRectangle(t,e,s,i){t=Math.round(t+this.offset.x),e=Math.round(e+this.offset.y),this.context.fillRect(t,e,s,i)}drawLineMesh(t){this.context.lineWidth=1,this.context.beginPath();let e=t[0];this.context.moveTo(Math.round(e.a.x+this.offset.x),Math.round(e.a.y+this.offset.y)),this.context.lineTo(Math.round(e.b.x+this.offset.x),Math.round(e.b.y+this.offset.y));for(let e=1,s=t.length;e<s;e++){let s=t[e];this.context.lineTo(Math.round(s.b.x+this.offset.x),Math.round(s.b.y+this.offset.y))}this.context.closePath(),this.context.stroke()}fillLineMesh(t){this.context.beginPath();let e=t[0];this.context.moveTo(Math.round(e.a.x+this.offset.x),Math.round(e.a.y+this.offset.y)),this.context.lineTo(Math.round(e.b.x+this.offset.x),Math.round(e.b.y+this.offset.y));for(let e=1,s=t.length;e<s;e++){let s=t[e];this.context.lineTo(Math.round(s.b.x+this.offset.x),Math.round(s.b.y+this.offset.y))}this.context.closePath(),this.context.fill()}drawSprite(t,e,s,i=t.width,n=t.height){e=Math.round(e+this.offset.x),s=Math.round(s+this.offset.y),this.context.drawImage(t,e,s,i,n)}drawLine(t,e,s,i,n){t=Math.round(t+this.offset.x),e=Math.round(e+this.offset.y),s=Math.round(s+this.offset.x),i=Math.round(i+this.offset.y),this.context.lineWidth=n,this.context.beginPath(),this.context.moveTo(t,e),this.context.lineTo(s,i),this.context.stroke(),this.context.closePath()}drawShape(t){let e=t[0];this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(Math.round(e.x+this.offset.x),Math.round(e.y+this.offset.y));for(let e=1,s=t.length;e<s;e++){let s=t[e];this.context.lineTo(Math.round(s.x+this.offset.x),Math.round(s.y+this.offset.y))}this.context.closePath(),this.context.stroke()}fillShape(t){let e=t[0];this.context.beginPath(),this.context.moveTo(Math.round(e.x+this.offset.x),Math.round(e.y+this.offset.y));for(let e=1,s=t.length;e<s;e++){let s=t[e];this.context.lineTo(Math.round(s.x+this.offset.x),Math.round(s.y+this.offset.y))}this.context.closePath(),this.context.fill()}translateRelative(t){this.offset.x=t.x+this.camera.position.x+this.center.x,this.offset.y=t.y+this.camera.position.y+this.center.y}translateToScreenCoordinates(t){this.offset.x=t.x,this.offset.y=t.y}getCanvas(){return this.canvas}screenToWorldCoordinates(t){return t.add(this.camera.position),t.sub(this.center),t}}(new class{position;constructor(t){this.position=t}moveTo(t){this.position.x=-t.x,this.position.y=-t.y}}(t.zeroVector),"gameScreen");class o{keys;keyBinds;constructor(t){this.keys=[],this.keyBinds=t,addEventListener("keydown",this.keyPressed.bind(this)),addEventListener("keyup",this.keyReleased.bind(this))}keyPressed(t){this.keys.includes(t.key)||this.keys.push(t.key)}keyReleased(t){try{this.keys.splice(this.keys.indexOf(t.key),1)}catch(t){}}releaseAllkeys(){this.keys=[]}handleKeys(){for(let t of this.keys)try{this.keyBinds[t]()}catch(t){}}}const h=.5*(Math.sqrt(3)-1),r=(3-Math.sqrt(3))/6,c=1/6,a=(Math.sqrt(5)-1)/4,l=(5-Math.sqrt(5))/20,f=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),d=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),x=class{p;perm;permMod12;constructor(t=Math.random){const e="function"==typeof t?t:function(t){let e=0,s=0,i=0,n=1;const o=function(){let t=4022871197;return function(e){e=e.toString();for(let s=0;s<e.length;s++){t+=e.charCodeAt(s);let i=.02519603282416938*t;t=i>>>0,i-=t,i*=t,t=i>>>0,i-=t,t+=4294967296*i}return 2.3283064365386963e-10*(t>>>0)}}();return e=o(" "),s=o(" "),i=o(" "),e-=o(t),e<0&&(e+=1),s-=o(t),s<0&&(s+=1),i-=o(t),i<0&&(i+=1),function(){const t=2091639*e+2.3283064365386963e-10*n;return e=s,s=i,i=t-(n=0|t)}}(t);this.p=function(t){const e=new Uint8Array(256);for(let t=0;t<256;t++)e[t]=t;for(let s=0;s<255;s++){const i=s+~~(t()*(256-s)),n=e[s];e[s]=e[i],e[i]=n}return e}(e),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(let t=0;t<512;t++)this.perm[t]=this.p[255&t],this.permMod12[t]=this.perm[t]%12}noise2D(t,e){const s=this.permMod12,i=this.perm;let n=0,o=0,c=0;const a=(t+e)*h,l=Math.floor(t+a),d=Math.floor(e+a),x=(l+d)*r,u=t-(l-x),y=e-(d-x);let g,m;u>y?(g=1,m=0):(g=0,m=1);const p=u-g+r,w=y-m+r,k=u-1+2*r,v=y-1+2*r,M=255&l,b=255&d;let S=.5-u*u-y*y;if(S>=0){const t=3*s[M+i[b]];S*=S,n=S*S*(f[t]*u+f[t+1]*y)}let L=.5-p*p-w*w;if(L>=0){const t=3*s[M+g+i[b+m]];L*=L,o=L*L*(f[t]*p+f[t+1]*w)}let P=.5-k*k-v*v;if(P>=0){const t=3*s[M+1+i[b+1]];P*=P,c=P*P*(f[t]*k+f[t+1]*v)}return 70*(n+o+c)}noise3D(t,e,s){const i=this.permMod12,n=this.perm;let o,h,r,a;const l=.3333333333333333*(t+e+s),d=Math.floor(t+l),x=Math.floor(e+l),u=Math.floor(s+l),y=(d+x+u)*c,g=t-(d-y),m=e-(x-y),p=s-(u-y);let w,k,v,M,b,S;g>=m?m>=p?(w=1,k=0,v=0,M=1,b=1,S=0):g>=p?(w=1,k=0,v=0,M=1,b=0,S=1):(w=0,k=0,v=1,M=1,b=0,S=1):m<p?(w=0,k=0,v=1,M=0,b=1,S=1):g<p?(w=0,k=1,v=0,M=0,b=1,S=1):(w=0,k=1,v=0,M=1,b=1,S=0);const L=g-w+c,P=m-k+c,C=p-v+c,E=g-M+2*c,A=m-b+2*c,T=p-S+2*c,B=g-1+.5,D=m-1+.5,z=p-1+.5,R=255&d,I=255&x,V=255&u;let q=.6-g*g-m*m-p*p;if(q<0)o=0;else{const t=3*i[R+n[I+n[V]]];q*=q,o=q*q*(f[t]*g+f[t+1]*m+f[t+2]*p)}let F=.6-L*L-P*P-C*C;if(F<0)h=0;else{const t=3*i[R+w+n[I+k+n[V+v]]];F*=F,h=F*F*(f[t]*L+f[t+1]*P+f[t+2]*C)}let W=.6-E*E-A*A-T*T;if(W<0)r=0;else{const t=3*i[R+M+n[I+b+n[V+S]]];W*=W,r=W*W*(f[t]*E+f[t+1]*A+f[t+2]*T)}let H=.6-B*B-D*D-z*z;if(H<0)a=0;else{const t=3*i[R+1+n[I+1+n[V+1]]];H*=H,a=H*H*(f[t]*B+f[t+1]*D+f[t+2]*z)}return 32*(o+h+r+a)}noise4D(t,e,s,i){const n=this.perm;let o,h,r,c,f;const x=(t+e+s+i)*a,u=Math.floor(t+x),y=Math.floor(e+x),g=Math.floor(s+x),m=Math.floor(i+x),p=(u+y+g+m)*l,w=t-(u-p),k=e-(y-p),v=s-(g-p),M=i-(m-p);let b=0,S=0,L=0,P=0;w>k?b++:S++,w>v?b++:L++,w>M?b++:P++,k>v?S++:L++,k>M?S++:P++,v>M?L++:P++;const C=b>=3?1:0,E=S>=3?1:0,A=L>=3?1:0,T=P>=3?1:0,B=b>=2?1:0,D=S>=2?1:0,z=L>=2?1:0,R=P>=2?1:0,I=b>=1?1:0,V=S>=1?1:0,q=L>=1?1:0,F=P>=1?1:0,W=w-C+l,H=k-E+l,U=v-A+l,K=M-T+l,N=w-B+2*l,O=k-D+2*l,j=v-z+2*l,G=M-R+2*l,J=w-I+3*l,Q=k-V+3*l,X=v-q+3*l,Y=M-F+3*l,Z=w-1+4*l,$=k-1+4*l,_=v-1+4*l,tt=M-1+4*l,et=255&u,st=255&y,it=255&g,nt=255&m;let ot=.6-w*w-k*k-v*v-M*M;if(ot<0)o=0;else{const t=n[et+n[st+n[it+n[nt]]]]%32*4;ot*=ot,o=ot*ot*(d[t]*w+d[t+1]*k+d[t+2]*v+d[t+3]*M)}let ht=.6-W*W-H*H-U*U-K*K;if(ht<0)h=0;else{const t=n[et+C+n[st+E+n[it+A+n[nt+T]]]]%32*4;ht*=ht,h=ht*ht*(d[t]*W+d[t+1]*H+d[t+2]*U+d[t+3]*K)}let rt=.6-N*N-O*O-j*j-G*G;if(rt<0)r=0;else{const t=n[et+B+n[st+D+n[it+z+n[nt+R]]]]%32*4;rt*=rt,r=rt*rt*(d[t]*N+d[t+1]*O+d[t+2]*j+d[t+3]*G)}let ct=.6-J*J-Q*Q-X*X-Y*Y;if(ct<0)c=0;else{const t=n[et+I+n[st+V+n[it+q+n[nt+F]]]]%32*4;ct*=ct,c=ct*ct*(d[t]*J+d[t+1]*Q+d[t+2]*X+d[t+3]*Y)}let at=.6-Z*Z-$*$-_*_-tt*tt;if(at<0)f=0;else{const t=n[et+1+n[st+1+n[it+1+n[nt+1]]]]%32*4;at*=at,f=at*at*(d[t]*Z+d[t+1]*$+d[t+2]*_+d[t+3]*tt)}return 27*(o+h+r+c+f)}};class u{mesh;config;xPosition;constructor(t,e,s){this.xPosition=s,this.config=e,this.mesh=this.makeLayout(t)}makeLayout(e){let i=[];for(let s=0,n=this.config.maxChunkSegments;s<=n;s++){let n,o,h,r;n=s*this.config.segmentLength+this.xPosition,h=e.noise2D(n/this.config.noiseSampleSize,0),r=0;for(let t=1;t<30;t++)h+=e.noise2D(n/this.config.noiseSampleSize*t,0)/Math.pow(2,t),r+=1/t;h/=r,h=h*this.config.maxLevelHeight/2,o=h,i.push(new t(n,o))}return i.push(new t(this.xPosition+this.config.maxChunkSegments*this.config.segmentLength,this.config.levelDownExtension)),i.push(new t(this.xPosition,this.config.levelDownExtension)),new s(i)}}const y=new class{config;chunks;noiseInstance;constructor(t){this.config=t,this.chunks=[],this.noiseInstance=new x,this.generateChunks()}checkPlayerCamera(e){let s,i,o,h;if(h=this.chunks[0].xPosition,s=e.position.x,i=s-n.center.x-h,o=this.chunks[this.chunks.length-1].xPosition+this.config.maxChunkSegments*this.config.segmentLength-s-n.center.x,i>0?n.camera.moveTo(e.position):n.camera.moveTo(new t(h+n.center.x,e.position.y)),e.position.x<=h&&(e.position.x=h),o<0){let t=this.chunks.shift();t.xPosition=this.chunks[this.chunks.length-1].xPosition+this.config.maxChunkSegments*this.config.segmentLength,t.mesh=t.makeLayout(this.noiseInstance),this.chunks.push(t)}}generateChunks(){let t=-this.config.maxChunkSegments*this.config.segmentLength-n.center.x;for(;!(t>n.width+this.config.maxChunkSegments*this.config.segmentLength+this.config.renderDistance);)this.chunks.push(new u(this.noiseInstance,this.config,t)),t+=this.config.maxChunkSegments*this.config.segmentLength}renderLevel(){n.translateRelative(t.zeroVector),this.chunks.forEach((t=>{n.color("green"),n.fillLineMesh(t.mesh.getMesh())}))}getChunkAt(t){let e=this;return 0==t&&(t+=1),function s(i,n,o){let h=Math.floor((n+o)/2),r=i[h];if(!r)return;let c=r.xPosition,a=r.xPosition+e.config.segmentLength*e.config.maxChunkSegments;return t>=c&&t<=a?r:t>c?s(i,h+1,o):s(i,n,h-1)}(this.chunks,0,this.chunks.length)}getCollidingLines(t){let e=[],s=[];return e.push(y.getChunkAt(t.position.x)),e.push(y.getChunkAt(t.position.x+t.dimensions.x)),e.forEach((e=>{e?.mesh.getMesh().forEach((e=>{e.intersectsAABB(t)&&s.push(e)}))})),s}}({segmentLength:10,maxLevelHeight:700,noiseSampleSize:2e3,renderDistance:500,maxChunkSegments:50,levelDownExtension:1500});class g{position;dimensions;velocity;acceleration;onground;maxSpeed;mass;id;sprite;gravity;constructor(e,s,i,n,o,h,r){this.position=e,this.dimensions=s,this.velocity=t.zeroVector,this.acceleration=t.zeroVector,this.onground=!1,this.maxSpeed=i,this.mass=h,this.gravity=r,this.id=n,this.sprite=o,this.init()}applyForce(t){t.x/=this.mass,t.y/=this.mass,this.acceleration.add(t)}update(e){this.velocity.x+=this.acceleration.x,this.velocity.y+=this.acceleration.y,this.velocity.x>this.maxSpeed&&(this.velocity.x=this.maxSpeed),this.velocity.x<-this.maxSpeed&&(this.velocity.x=-this.maxSpeed),this.position.x+=this.velocity.x*e,this.position.y+=this.velocity.y*e,0==this.acceleration.x&&(this.velocity.x*=.9),0==this.acceleration.y&&(this.velocity.y*=.9),this.acceleration=t.zeroVector,this.onground=!1,this.applyForce(new t(0,this.gravity));let s=y.getCollidingLines(this);for(let t=0,e=s.length;t<e;t++){for(;s[t].intersectsAABB(this);)this.position.y-=.5;this.onground=!0,this.velocity.y=0}this.tick()}render(){n.translateRelative(this.position),n.drawSprite(this.sprite,0,0,this.dimensions.x,this.dimensions.y),n.translateRelative(new t(0,0))}}const m=new class{entities;constructor(){this.entities=[]}getEntity(t){for(let e of this.entities)if(e.id==t)return e;return null}newEntity(t){this.entities.includes(t)||this.entities.push(t)}removeEntity(t){this.entities.includes(t)&&this.entities.splice(this.entities.indexOf(t),1)}update(t){this.entities.forEach((e=>{e.update(t)}))}render(){this.entities.forEach((t=>{t.render()}))}};class p extends g{constructor(e,s,i){super(e,new t(s,s),10,"rock",i,s,9.81)}init(){this.velocity=new t(Math.round(10*Math.random()-5),0)}tick(){}}class w extends g{alive;speed;constructor(t,e,s){super(t,e,10,"player",s,10,9.81),this.alive=!0,this.speed=2}init(){}tick(){}move(t){switch(t){case 0:this.acceleration.x=-this.speed;break;case 1:this.acceleration.x=this.speed;break;case 2:this.onground&&(this.acceleration.y=-20)}}}let k,v,M;let b,S,L,P,C,E=!0;const A=1e3/60;let T,B,D;function z(){if(!E)return;let e=Date.now();B=(e-T)/A,D+=e-T,T=e,b.handleKeys(),m.update(B),y.checkPlayerCamera(S),D>A&&(n.clear(),n.translateToScreenCoordinates(new t(n.camera.position.x/4,n.camera.position.y/4)),n.drawSprite(L.Background1,0,0),y.renderLevel(),m.render(),D=0),requestAnimationFrame(z)}onload=async function(){L={},L.rock1=await i("./src/assets/rock1.png"),L.player=await i("./src/assets/player.png"),L.Background1=await i((k=document.createElement("canvas"),v=k.getContext("2d"),M=new x,k.width=1920,k.height=1080,v.clearRect(0,0,1920,1080),v.fillStyle="red",v.fillRect(0,0,100,100),v.fillStyle="blue",v.fillRect(50,50,200,200),k.toDataURL())),S=new w(new t(0,-300),new t(50,100),L.player),m.newEntity(S),m.newEntity(new p(new t(0,-500),200,L.rock1)),b=new o({a:()=>S.move(0),d:()=>S.move(1)," ":()=>S.move(2),r:()=>{E||(D=0,T=Date.now(),z())}}),C=document.getElementById("button-resume"),P=document.getElementById("menu"),C.onclick=()=>{E||(D=0,T=Date.now(),E=!0,z(),P.style.visibility="hidden")},addEventListener("blur",(()=>{b.releaseAllkeys(),E=!1,P.style.visibility="visible"})),D=0,T=Date.now(),z()}})();
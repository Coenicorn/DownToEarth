(()=>{"use strict";function t(t){return new Promise(((e,s)=>{let i=new Image;i.src=t,i.onload=()=>e(i),i.onerror=()=>{throw new Error("Image not found")}}))}const e=new class{canvas;context;width;height;offset;center;camera;constructor(t,e){this.canvas=e?document.getElementById(e):document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.width=innerWidth,this.height=innerHeight,this.canvas.width=this.width,this.canvas.height=this.height,addEventListener("resize",this.resize.bind(this)),this.offset={x:0,y:0},this.center={x:this.width/2,y:this.height/2},this.camera=t}resize(){this.width=innerWidth,this.height=innerHeight,this.canvas.width=this.width,this.canvas.height=this.height}clear(){this.context.clearRect(0,0,this.width,this.height)}color(t){this.context.fillStyle=t}drawRectangle(t,e,s,i){t=Math.round(t+this.offset.x),e=Math.round(e+this.offset.y),this.context.fillRect(t,e,s,i)}drawLineMesh(t){this.context.lineWidth=1,this.context.beginPath();let e=t[0];this.context.moveTo(Math.round(e.a.x+this.offset.x),Math.round(e.a.y+this.offset.y)),this.context.lineTo(Math.round(e.b.x+this.offset.x),Math.round(e.b.y+this.offset.y));for(let e=1,s=t.length;e<s;e++){let s=t[e];this.context.lineTo(Math.round(s.b.x+this.offset.x),Math.round(s.b.y+this.offset.y))}this.context.closePath(),this.context.stroke()}fillLineMesh(t){this.context.beginPath();let e=t[0];this.context.moveTo(Math.round(e.a.x+this.offset.x),Math.round(e.a.y+this.offset.y)),this.context.lineTo(Math.round(e.b.x+this.offset.x),Math.round(e.b.y+this.offset.y));for(let e=1,s=t.length;e<s;e++){let s=t[e];this.context.lineTo(Math.round(s.b.x+this.offset.x),Math.round(s.b.y+this.offset.y))}this.context.closePath(),this.context.fill()}drawSprite(t,e,s,i=t.width,n=t.height){e=Math.round(e+this.offset.x),s=Math.round(s+this.offset.y),this.context.drawImage(t,e,s,i,n)}drawLine(t,e,s,i,n){t=Math.round(t+this.offset.x),e=Math.round(e+this.offset.y),s=Math.round(s+this.offset.x),i=Math.round(i+this.offset.y),this.context.lineWidth=n,this.context.beginPath(),this.context.moveTo(t,e),this.context.lineTo(s,i),this.context.stroke(),this.context.closePath()}drawShape(t){let e=t[0];this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(Math.round(e.x+this.offset.x),Math.round(e.y+this.offset.y));for(let e=1,s=t.length;e<s;e++){let s=t[e];this.context.lineTo(Math.round(s.x+this.offset.x),Math.round(s.y+this.offset.y))}this.context.closePath(),this.context.stroke()}fillShape(t){let e=t[0];this.context.beginPath(),this.context.moveTo(Math.round(e.x+this.offset.x),Math.round(e.y+this.offset.y));for(let e=1,s=t.length;e<s;e++){let s=t[e];this.context.lineTo(Math.round(s.x+this.offset.x),Math.round(s.y+this.offset.y))}this.context.closePath(),this.context.fill()}translateRelative(t){this.offset.x=t.x+this.camera.position.x+this.center.x,this.offset.y=t.y+this.camera.position.y+this.center.y}translateToScreenCoordinates(t){this.offset.x=t.x,this.offset.y=t.y}getCanvas(){return this.canvas}screenToWorldCoordinates(t){return t.x+=this.camera.position.x,t.y+=this.camera.position.y,t.x+=this.center.x,t.y+=this.center.y,t}}(new class{position;constructor(t){this.position=t}moveTo(t){this.position.x=-t.x,this.position.y=-t.y}}({x:0,y:0}),"gameScreen");class s{keys;keyBinds;constructor(t){this.keys=[],this.keyBinds=t,addEventListener("keydown",this.keyPressed.bind(this)),addEventListener("keyup",this.keyReleased.bind(this))}keyPressed(t){this.keys.includes(t.key)||this.keys.push(t.key)}keyReleased(t){try{this.keys.splice(this.keys.indexOf(t.key),1)}catch(t){}}releaseAllkeys(){this.keys=[]}handleKeys(){for(let t of this.keys)try{this.keyBinds[t]()}catch(t){}}}const i=.5*(Math.sqrt(3)-1),n=(3-Math.sqrt(3))/6,o=1/6,h=(Math.sqrt(5)-1)/4,r=(5-Math.sqrt(5))/20,a=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),c=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),l=class{p;perm;permMod12;constructor(t=Math.random){const e="function"==typeof t?t:function(t){let e=0,s=0,i=0,n=1;const o=function(){let t=4022871197;return function(e){e=e.toString();for(let s=0;s<e.length;s++){t+=e.charCodeAt(s);let i=.02519603282416938*t;t=i>>>0,i-=t,i*=t,t=i>>>0,i-=t,t+=4294967296*i}return 2.3283064365386963e-10*(t>>>0)}}();return e=o(" "),s=o(" "),i=o(" "),e-=o(t),e<0&&(e+=1),s-=o(t),s<0&&(s+=1),i-=o(t),i<0&&(i+=1),function(){const t=2091639*e+2.3283064365386963e-10*n;return e=s,s=i,i=t-(n=0|t)}}(t);this.p=function(t){const e=new Uint8Array(256);for(let t=0;t<256;t++)e[t]=t;for(let s=0;s<255;s++){const i=s+~~(t()*(256-s)),n=e[s];e[s]=e[i],e[i]=n}return e}(e),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(let t=0;t<512;t++)this.perm[t]=this.p[255&t],this.permMod12[t]=this.perm[t]%12}noise2D(t,e){const s=this.permMod12,o=this.perm;let h=0,r=0,c=0;const l=(t+e)*i,d=Math.floor(t+l),x=Math.floor(e+l),f=(d+x)*n,y=t-(d-f),m=e-(x-f);let u,g;y>m?(u=1,g=0):(u=0,g=1);const p=y-u+n,k=m-g+n,w=y-1+2*n,M=m-1+2*n,v=255&d,S=255&x;let L=.5-y*y-m*m;if(L>=0){const t=3*s[v+o[S]];L*=L,h=L*L*(a[t]*y+a[t+1]*m)}let T=.5-p*p-k*k;if(T>=0){const t=3*s[v+u+o[S+g]];T*=T,r=T*T*(a[t]*p+a[t+1]*k)}let b=.5-w*w-M*M;if(b>=0){const t=3*s[v+1+o[S+1]];b*=b,c=b*b*(a[t]*w+a[t+1]*M)}return 70*(h+r+c)}noise3D(t,e,s){const i=this.permMod12,n=this.perm;let h,r,c,l;const d=.3333333333333333*(t+e+s),x=Math.floor(t+d),f=Math.floor(e+d),y=Math.floor(s+d),m=(x+f+y)*o,u=t-(x-m),g=e-(f-m),p=s-(y-m);let k,w,M,v,S,L;u>=g?g>=p?(k=1,w=0,M=0,v=1,S=1,L=0):u>=p?(k=1,w=0,M=0,v=1,S=0,L=1):(k=0,w=0,M=1,v=1,S=0,L=1):g<p?(k=0,w=0,M=1,v=0,S=1,L=1):u<p?(k=0,w=1,M=0,v=0,S=1,L=1):(k=0,w=1,M=0,v=1,S=1,L=0);const T=u-k+o,b=g-w+o,P=p-M+o,C=u-v+2*o,E=g-S+2*o,A=p-L+2*o,R=u-1+.5,B=g-1+.5,D=p-1+.5,F=255&x,I=255&f,U=255&y;let q=.6-u*u-g*g-p*p;if(q<0)h=0;else{const t=3*i[F+n[I+n[U]]];q*=q,h=q*q*(a[t]*u+a[t+1]*g+a[t+2]*p)}let z=.6-T*T-b*b-P*P;if(z<0)r=0;else{const t=3*i[F+k+n[I+w+n[U+M]]];z*=z,r=z*z*(a[t]*T+a[t+1]*b+a[t+2]*P)}let W=.6-C*C-E*E-A*A;if(W<0)c=0;else{const t=3*i[F+v+n[I+S+n[U+L]]];W*=W,c=W*W*(a[t]*C+a[t+1]*E+a[t+2]*A)}let H=.6-R*R-B*B-D*D;if(H<0)l=0;else{const t=3*i[F+1+n[I+1+n[U+1]]];H*=H,l=H*H*(a[t]*R+a[t+1]*B+a[t+2]*D)}return 32*(h+r+c+l)}noise4D(t,e,s,i){const n=this.perm;let o,a,l,d,x;const f=(t+e+s+i)*h,y=Math.floor(t+f),m=Math.floor(e+f),u=Math.floor(s+f),g=Math.floor(i+f),p=(y+m+u+g)*r,k=t-(y-p),w=e-(m-p),M=s-(u-p),v=i-(g-p);let S=0,L=0,T=0,b=0;k>w?S++:L++,k>M?S++:T++,k>v?S++:b++,w>M?L++:T++,w>v?L++:b++,M>v?T++:b++;const P=S>=3?1:0,C=L>=3?1:0,E=T>=3?1:0,A=b>=3?1:0,R=S>=2?1:0,B=L>=2?1:0,D=T>=2?1:0,F=b>=2?1:0,I=S>=1?1:0,U=L>=1?1:0,q=T>=1?1:0,z=b>=1?1:0,W=k-P+r,H=w-C+r,K=M-E+r,N=v-A+r,O=k-R+2*r,j=w-B+2*r,G=M-D+2*r,J=v-F+2*r,Q=k-I+3*r,V=w-U+3*r,X=M-q+3*r,Y=v-z+3*r,Z=k-1+4*r,$=w-1+4*r,_=M-1+4*r,tt=v-1+4*r,et=255&y,st=255&m,it=255&u,nt=255&g;let ot=.6-k*k-w*w-M*M-v*v;if(ot<0)o=0;else{const t=n[et+n[st+n[it+n[nt]]]]%32*4;ot*=ot,o=ot*ot*(c[t]*k+c[t+1]*w+c[t+2]*M+c[t+3]*v)}let ht=.6-W*W-H*H-K*K-N*N;if(ht<0)a=0;else{const t=n[et+P+n[st+C+n[it+E+n[nt+A]]]]%32*4;ht*=ht,a=ht*ht*(c[t]*W+c[t+1]*H+c[t+2]*K+c[t+3]*N)}let rt=.6-O*O-j*j-G*G-J*J;if(rt<0)l=0;else{const t=n[et+R+n[st+B+n[it+D+n[nt+F]]]]%32*4;rt*=rt,l=rt*rt*(c[t]*O+c[t+1]*j+c[t+2]*G+c[t+3]*J)}let at=.6-Q*Q-V*V-X*X-Y*Y;if(at<0)d=0;else{const t=n[et+I+n[st+U+n[it+q+n[nt+z]]]]%32*4;at*=at,d=at*at*(c[t]*Q+c[t+1]*V+c[t+2]*X+c[t+3]*Y)}let ct=.6-Z*Z-$*$-_*_-tt*tt;if(ct<0)x=0;else{const t=n[et+1+n[st+1+n[it+1+n[nt+1]]]]%32*4;ct*=ct,x=ct*ct*(c[t]*Z+c[t+1]*$+c[t+2]*_+c[t+3]*tt)}return 27*(o+a+l+d+x)}};class d{a;b;surfaceNormal;constructor(t,e){this.a=t,this.b=e;let s={x:this.b.x-this.a.x,y:this.b.y-this.a.y},i=Math.sqrt(Math.pow(s.x,2)+Math.pow(s.y,2));s.x/=i,s.y/=i,this.surfaceNormal={x:s.y,y:-s.x}}intersectsLine(t){let e,s,i,n,o,h,r,a;e=this.a.x,s=this.a.y,i=this.b.x,n=this.b.y,o=t.a.x,h=t.a.y,r=t.b.x,a=t.b.y;let c=(e-i)*(h-a)-(s-n)*(o-r);if(0==c)return;let l=((e-o)*(h-a)-(s-h)*(o-r))/c,d=((e-o)*(s-n)-(s-h)*(e-i))/c;return l>=0&&l<=1&&d>=0&&d<=1?{x:e+l*(i-e),y:s+l*(n-s)}:void 0}intersectsAABB(t){let e,s,i,n,o,h,r,a,c,l,x,f;return e=t.position.x,o=t.position.y,s=t.position.x+t.dimensions.x,h=t.position.y,i=t.position.x+t.dimensions.x,r=t.position.y+t.dimensions.y,n=t.position.x,a=t.position.y+t.dimensions.y,c=new d({x:e,y:o},{x:s,y:h}),l=new d({x:s,y:h},{x:i,y:r}),x=new d({x:i,y:r},{x:n,y:a}),f=new d({x:n,y:a},{x:e,y:o}),null!=this.intersectsLine(c)||null!=this.intersectsLine(l)||null!=this.intersectsLine(x)||null!=this.intersectsLine(f)}}class x{mesh;constructor(t){this.mesh=[];for(let e=1,s=t.length;e<s;e++)this.mesh.push(new d({x:t[e-1].x,y:t[e-1].y},{x:t[e].x,y:t[e].y}));this.mesh.push(new d({x:t[t.length-1].x,y:t[t.length-1].y},{x:t[0].x,y:t[0].y}))}static meshFromAABB(t){let e,s,i,n,o,h,r,a;return e=t.position.x,o=t.position.y,s=t.position.x+t.dimensions.x,h=t.position.y,i=t.position.x+t.dimensions.x,r=t.position.y+t.dimensions.y,n=t.position.x,a=t.position.y+t.dimensions.y,new x([{x:e,y:o},{x:s,y:h},{x:i,y:r},{x:n,y:a}])}getMesh(){return this.mesh}}class f{mesh;config;xPosition;constructor(t,e,s){this.xPosition=s,this.config=e,this.mesh=this.makeLayout(t)}makeLayout(t){let e=[];for(let s=0,i=this.config.maxChunkSegments;s<=i;s++){let i,n,o,h;i=s*this.config.segmentLength+this.xPosition,o=t.noise2D(i/this.config.noiseSampleSize,0),h=0;for(let e=1;e<30;e++)o+=t.noise2D(i/this.config.noiseSampleSize*e,0)/Math.pow(2,e),h+=1/e;o/=h,o=o*this.config.maxLevelHeight/2,n=o,e.push({x:i,y:n})}return e.push({x:this.xPosition+this.config.maxChunkSegments*this.config.segmentLength,y:this.config.levelDownExtension}),e.push({x:this.xPosition,y:this.config.levelDownExtension}),new x(e)}}const y=new class{config;chunks;noiseInstance;constructor(t){this.config=t,this.chunks=[],this.noiseInstance=new l,this.generateChunks()}checkPlayerCamera(t){let s,i,n,o;if(o=this.chunks[0].xPosition,s=t.position.x,i=s-e.center.x-o,n=this.chunks[this.chunks.length-1].xPosition+this.config.maxChunkSegments*this.config.segmentLength-s-e.center.x,i>0?e.camera.moveTo(t.position):e.camera.moveTo({x:o+e.center.x,y:t.position.y}),t.position.x<=o&&(t.position.x=o),n<0){let t=this.chunks.shift();t.xPosition=this.chunks[this.chunks.length-1].xPosition+this.config.maxChunkSegments*this.config.segmentLength,t.mesh=t.makeLayout(this.noiseInstance),this.chunks.push(t)}}generateChunks(){let t=-this.config.maxChunkSegments*this.config.segmentLength-e.center.x;for(;!(t>e.width+this.config.maxChunkSegments*this.config.segmentLength+this.config.renderDistance);)this.chunks.push(new f(this.noiseInstance,this.config,t)),t+=this.config.maxChunkSegments*this.config.segmentLength}renderLevel(){e.translateRelative({x:0,y:0}),this.chunks.forEach((t=>{e.color("green"),e.fillLineMesh(t.mesh.getMesh())}))}getChunkAt(t){let e=this;return 0==t&&(t+=1),function s(i,n,o){let h=Math.floor((n+o)/2),r=i[h];if(!r)return;let a=r.xPosition,c=r.xPosition+e.config.segmentLength*e.config.maxChunkSegments;return t>=a&&t<=c?r:t>a?s(i,h+1,o):s(i,n,h-1)}(this.chunks,0,this.chunks.length)}getCollidingLines(t){let e=[],s=[];return e.push(y.getChunkAt(t.position.x)),e.push(y.getChunkAt(t.position.x+t.dimensions.x)),e.forEach((e=>{e?.mesh.getMesh().forEach((e=>{e.intersectsAABB(t)&&s.push(e)}))})),s}}({segmentLength:10,maxLevelHeight:700,noiseSampleSize:2e3,renderDistance:500,maxChunkSegments:50,levelDownExtension:1500});class m{position;velocity;dimensions;sprite;onground;constructor(t,e,s){this.position=t,this.dimensions=e,this.velocity={x:0,y:0},this.sprite=s,this.onground=!1,this.init()}update(t){this.position.x+=this.velocity.x*t,this.position.y+=this.velocity.y*t,this.onground=!1;let e=y.getCollidingLines(this);for(let t=0,s=e.length;t<s;t++){for(;e[t].intersectsAABB(this);)this.position.y-=.5;this.onground=!0,this.velocity.y=0}this.tick()}render(){e.translateRelative(this.position),e.drawSprite(this.sprite,0,0,this.dimensions.x,this.dimensions.y),e.translateRelative({x:0,y:0})}}const u=new class{entities;constructor(){this.entities=[]}newEntity(t){this.entities.includes(t)||this.entities.push(t)}removeEntity(t){this.entities.includes(t)&&this.entities.splice(this.entities.indexOf(t),1)}update(t){this.entities.forEach((e=>{e.update(t)}))}render(){this.entities.forEach((t=>{t.render()}))}};class g extends m{mass;constructor(t,e,s){super(t,{x:e,y:e},s),this.mass=e}init(){}tick(){this.velocity.y+=5/this.mass}}class p extends m{alive;maxSpeed;speed;constructor(t,e,s){super(t,e,s),this.alive=!0,this.speed=2,this.maxSpeed=10}init(){}tick(){this.velocity.x>this.maxSpeed&&(this.velocity.x=this.maxSpeed),this.velocity.x<-this.maxSpeed&&(this.velocity.x=-this.maxSpeed),this.velocity.x*=.95,this.velocity.y+=1}move(t){switch(t){case 0:this.velocity.x-=this.speed;break;case 1:this.velocity.x+=this.speed;break;case 2:this.onground&&(this.velocity.y-=20)}}}let k,w,M;const v=new class{dt;fps;desiredFrameTime;frameTime;timeSinceLastUpdate;renderTimer;constructor(){this.dt=0,this.desiredFrameTime=0,this.frameTime=0,this.fps=0,this.timeSinceLastUpdate=0,this.renderTimer=0}update(){let t=Date.now();this.frameTime=t-this.timeSinceLastUpdate,this.dt=this.frameTime/this.desiredFrameTime,this.timeSinceLastUpdate=t,this.renderTimer+=this.frameTime}resetRendertimer(){this.renderTimer=0}reset(){this.timeSinceLastUpdate=Date.now()}setFps(t){this.fps=t,this.desiredFrameTime=1e3/this.fps}getFps(){return this.fps}get canRender(){return this.renderTimer>this.desiredFrameTime}get deltaTime(){return this.dt}};let S,L,T,b,P,C=!0,E=0,A=.5;function R(){v.update(),C&&(S.handleKeys(),u.update(v.deltaTime),E+=1,E>200&&Math.random()>A&&(function(t){let e={x:t.position.x+500*Math.random(),y:-600},s=new g(e,Math.round(70*Math.random())+30,T.rock1);u.newEntity(s)}(L),E=0,A=2),y.checkPlayerCamera(L)),v.canRender&&(e.clear(),e.translateToScreenCoordinates({x:e.camera.position.x/4,y:e.camera.position.y/4}),e.drawSprite(T.Background1,0,0),y.renderLevel(),u.render(),v.resetRendertimer()),requestAnimationFrame(R)}onload=async function(){T={},T.rock1=await t("./src/assets/rock1.png"),T.player=await t("./src/assets/player.png"),T.Background1=await t((k=document.createElement("canvas"),w=k.getContext("2d"),M=new l,k.width=1920,k.height=1080,w.clearRect(0,0,1920,1080),w.fillStyle="red",w.fillRect(0,0,100,100),w.fillStyle="blue",w.fillRect(50,50,200,200),k.toDataURL())),L=new p({x:0,y:-300},{x:50,y:100},T.player),u.newEntity(L),S=new s({a:()=>L.move(0),d:()=>L.move(1)," ":()=>L.move(2)}),P=document.getElementById("button-resume"),b=document.getElementById("menu"),P.onclick=()=>{C||(v.reset(),C=!0,b.style.visibility="hidden")},addEventListener("blur",(()=>{S.releaseAllkeys(),C=!1,b.style.visibility="visible"})),v.reset(),v.setFps(60),R()}})();